
/// <reference path="jquery.min.js" />

/* ===================================================================================
* 版权声明：Copyright (C) 1998-2016 Westone 版权所有
* 类    别：统一身份认证jquery扩展插件
* 文件描述：将统一身份认证前端功能以插件方式进行封装，方便调用。
* 创 建 人：张博
* ==================================================================================*/

$.extend({
    // 单点登录
    idauth: function (options) {
        var challengeUrl = options.challengeUrl;
        var idauthUrl = options.idauthUrl;
        var controlId = options.controlId;
        var webSocketUrl = options.webSocketUrl == undefined ? "ws://127.0.0.1:36107" : options.webSocketUrl;

        if(options.onSubmit){
        	options.onSubmit();
        }
        $.ajax({
            type: "POST",
            url: challengeUrl,
            dataType: "json",
            success: function (data) {
            	if(data.code!=0){
            		   $.messager.alert("提示", data.message, "info");
            		   return false;
            	}
                if (controlId == undefined) {
                    // 使用WebSocket技术单点登录
                    $.idauthViaWebSocket(data.message, webSocketUrl, idauthUrl, options);
                } else {
                    // 使用客户端控件单点登录
                    $.idauthViaControl(data.message, controlId, idauthUrl, options);
                }
            },
            error: function (data) {
                alert(data.failReason);
            }
        });
    },
    

    // 采用客户端控件技术获取认证数据
  idauthViaControl: function (challenge, controlId, idauthUrl, options) {
    	
        var control = document.getElementById(controlId);
        // 调用控件进行挑战数签名并获取身份票据
        var value=control.GetSignAndToken(challenge);
        if(control.lResult != 0){
          //$.messager.alert("提示", "获取票据失败", "info");
        	if(options.onError){
        		options.onError("客户端处理错误:"+control.bstrError)
        	}
          return false;
        }
       

        $.idauthSubmit(control.bstrSignValAndToken, idauthUrl, options);
    	
//    	var value=1;
//    	if(value!=0){
//    		 alert("客户端处理错误：获取票据失败", "info");
//             return false;
//    	}
//    	
//    	 $.idauthSubmit("123", idauthUrl, redirectUrl);
    	
    	
    	
    },
    // 采用WebSocket技术获取认证数据
    idauthViaWebSocket: function (challenge, webSocketUrl, idauthUrl, options) {
        // 调用WebSocket进行挑战数签名并获取身份票据
        var body = "<body><plain><info><random>" + challenge + "</random></info></plain></body>";

        // 获取WebSocket消息体长度
        var bodyLength = 0;
        for (var i = 0; i < body.length; i++) {
            if (body.charAt(i).match(/^[\u4e00-\u9fa5]+$/)) {
                bodyLength += 3;
            } else {
                bodyLength++;
            }
        }

        bodyLength = String(bodyLength);
        var length = 10 - bodyLength.length;
        for (i = 0; i < length ; i++) {
            bodyLength = "0" + bodyLength;
        }

        // 创建到认证客户端WebSocket服务的连接
        var webSocket = new WebSocket(webSocketUrl);
        webSocket.onopen = function (event) {
            webSocket.send("<head><bsid>   ml0305c</bsid><bodylen>" + bodyLength + "</bodylen><digest_id>                    </digest_id><cipher_id>                    </cipher_id></head>" + body + "");
        }
        webSocket.onerror = function (event) {
            // 未登录时，没有进入到错误事件方法里
        	 if (options.onError) {
                 options.onError("客户端处理错误!");
             }
        }
        webSocket.onclose = function (event) {
            //alert("ws:close");
        }
        webSocket.onmessage = function (event) {
            var signAndToken = event.data.split("</appendix>")[0].split("<appendix>")[1];
            $.idauthSubmit(signAndToken, idauthUrl, options);
        }
    },
    // 提交认证
    idauthSubmit: function (signAndToken, idauthUrl, options) {
        // 由于未登录时，没有进入到错误事件方法里，因此这里先应急处理。
        if (signAndToken == "sign random error") {
        	 if (options.onError) {
                 options.onError("客户端处理错误，请确认是否进行身份认证！");
                 return false;
             }
        }
        
        $.ajax({
            type: "POST",
            dataType: "json",
            data: { signAndToken: signAndToken },
            url: idauthUrl,
            success: function (result) {
            	if(result.code==0){
            		 if (options.onSuccess) {
                         options.onSuccess();
                     }
           	}else {
                   $.messager.alert("提示", result.message, "info");
               }
            },
            error: function (result) {
            	 if (options.onError) {
                     options.onError(data.responseText);
                 }

                 return false;
            }
        });
    }
});